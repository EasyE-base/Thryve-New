rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Instructor marketplace profiles (read by all authenticated users)
    match /instructors/{instructorId} {
      allow read: if request.auth != null;
      allow write: if request.auth.uid == instructorId;
    }
    
    // Studio booking requests
    match /studios/{studioId}/bookingRequests/{requestId} {
      allow read: if request.auth.uid == resource.data.instructorId
                   || request.auth.uid in get(/databases/$(database)/documents/studios/$(studioId)).data.admins;
      allow create: if request.auth.uid in get(/databases/$(database)/documents/studios/$(studioId)).data.admins;
      allow update: if request.auth.uid == resource.data.instructorId  // For accepting/declining
                    || request.auth.uid in get(/databases/$(database)/documents/studios/$(studioId)).data.admins;
    }
    
    // Instructor's view of booking requests
    match /users/{userId}/bookingRequests/{requestId} {
      allow read: if request.auth.uid == userId;
      allow write: if false;  // Only written by Cloud Functions
    }
    
    // Reviews (studios can write, everyone can read)
    match /instructors/{instructorId}/reviews/{reviewId} {
      allow read: if request.auth != null;
      allow create: if request.auth.uid in get(/databases/$(database)/documents/studios/$(resource.data.studioId)).data.admins;
      allow update, delete: if false;  // Reviews are immutable
    }
    
    // Payment transactions (restricted access)
    match /payments/{transactionId} {
      allow read: if request.auth.uid == resource.data.instructorId
                   || request.auth.uid in get(/databases/$(database)/documents/studios/$(resource.data.studioId)).data.admins;
      allow write: if false;  // Only Cloud Functions can write payments
    }
    
    // Instructor verification (instructor and admin only)
    match /instructors/{instructorId}/verification {
      allow read, write: if request.auth.uid == instructorId;
      allow read: if request.auth.token.admin == true;  // Thryve admins
    }
    
    // Marketplace stats (read by all authenticated users)
    match /marketplace/stats {
      allow read: if request.auth != null;
      allow write: if false;  // Only Cloud Functions can update stats
    }
  }
}
